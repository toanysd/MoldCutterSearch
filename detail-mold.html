<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi tiết khuôn - MoldCutterSearch V6.5</title>
    <!-- V6.5 - Final version with conditional header + Modern UI + Official report -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="detail-mold-styles.css">
</head>
<body class="mold-detail-page">
    
    <!-- ===== V6.5: DYNAMIC HEADER BASED ON LOCATION ===== -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="javascript:goBack()" class="back-btn">← 戻る</a>
                <div class="mold-header-info">
                    <div class="mold-title-row">
                        <h1 class="mold-title" id="moldTitle">Loading...</h1>
                        <div class="mold-location" id="moldLocation">
                            📍 位置情報読み込み中...
                        </div>
                    </div>
                    <!-- V6.5: Conditional subtitle - hidden when at other company -->
                    <p class="mold-subtitle" id="moldSubtitle">金型詳細情報 / Thông tin chi tiết khuôn</p>
                </div>
            </div>
            
            <div class="header-actions">
                <button id="showLocationBtn" class="action-btn">📍位置</button>
                <button id="showShipmentBtn" class="action-btn">🚚出荷</button>
                <button id="showCommentBtn" class="action-btn">💬コメント</button>
                <button onclick="generateOfficialReport()" class="action-btn">🖨️公式報告</button>
                <button onclick="generateOfficialPDF()" class="action-btn">📄PDF</button>
                <button onclick="reloadMoldDataFromGitHub()" class="action-btn">🔄更新</button>
            </div>
        </div>
    </header>

    <!-- ===== V6.5: OFFICIAL REPORT PRINT LAYOUT - HIDDEN ON SCREEN ===== -->
    <div id="officialReportContent" class="print-only">
        <!-- This content is populated by JavaScript using official form template -->
    </div>

    <!-- ===== TAB NAVIGATION V6.5 - FIXED BELOW HEADER ===== -->
    <nav class="tab-navigation">
        <ul class="tab-nav">
            <li><a href="#summary" class="tab-link active" data-tab="summary">📋総合</a></li>
            <li><a href="#product" class="tab-link" data-tab="product">📦製品</a></li>
            <li><a href="#technical" class="tab-link" data-tab="technical">⚙️技術</a></li>
            <li><a href="#processing" class="tab-link" data-tab="processing">🔄処理</a></li>
        </ul>
    </nav>

    <!-- ===== TAB CONTENT V6.5 - MODERN UI ===== -->
    <div class="tab-content-wrapper">
        
        <!-- Tab 1: 総合 (Summary) -->
        <div id="summary" class="tab-pane active">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">📋</div>
                    <h2 class="section-title">基本情報 / Thông tin cơ bản</h2>
                </div>
                <div id="summaryBasicInfo">
                    <!-- Populated by JavaScript displaySummaryBasicInfo() with conditional location logic -->
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">📦</div>
                    <h2 class="section-title">トレイ情報 / Thông tin khay</h2>
                </div>
                <div id="summaryTrayInfo">
                    <!-- Populated by JavaScript displaySummaryTrayInfo() -->
                </div>
            </div>

            <div class="content-section cutters-section">
                <div class="section-header">
                    <div class="section-icon">🔧</div>
                    <h2 class="section-title">関連カッター / Dao cắt liên quan</h2>
                </div>
                <div id="summaryRelatedCutters">
                    <!-- Populated by JavaScript displaySummaryRelatedCutters() -->
                </div>
            </div>
        </div>

        <!-- Tab 2: 製品 (Product) -->
        <div id="product" class="tab-pane">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">📦</div>
                    <h2 class="section-title">製品情報 / Thông tin sản phẩm</h2>
                </div>
                <div id="productInfo">
                    <!-- Populated by JavaScript displayProductTab() -->
                </div>
            </div>
        </div>

        <!-- Tab 3: 技術 (Technical) - V6.5: Modern 2-column with enhanced distinction -->
        <div id="technical" class="tab-pane">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">⚙️</div>
                    <h2 class="section-title">技術情報 / Thông tin kỹ thuật</h2>
                </div>
                <div id="technicalInfo">
                    <!-- Populated by JavaScript displayTechnicalTab() with modern 2-column layout -->
                </div>
            </div>
        </div>

        <!-- Tab 4: 処理 (Processing) - V6.5: Compact spacing -->
        <div id="processing" class="tab-pane">
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">🔄</div>
                    <h2 class="section-title">処理状況 / Trạng thái xử lý</h2>
                </div>
                <div id="processingStatus">
                    <!-- Populated by JavaScript displayProcessingStatus() -->
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-icon">📍</div>
                        <h2 class="section-title">位置履歴 / Lịch sử vị trí</h2>
                    </div>
                    <div id="processingLocationHistory" class="history-grid">
                        <!-- Populated by JavaScript displayProcessingLocationHistory() -->
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <div class="section-icon">🚚</div>
                        <h2 class="section-title">出荷履歴 / Lịch sử vận chuyển</h2>
                    </div>
                    <div id="processingShipmentHistory" class="history-grid">
                        <!-- Populated by JavaScript displayProcessingShipmentHistory() -->
                    </div>
                </div>
            </div>

            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">💬</div>
                    <h2 class="section-title">ユーザーコメント / Bình luận người dùng</h2>
                </div>
                <div id="processingUserComments">
                    <!-- Populated by JavaScript displayProcessingUserComments() -->
                </div>
            </div>
        </div>

    </div>

    <!-- ===== MODALS V6.5 ===== -->
    
    <!-- Location Update Modal -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">位置更新 / Cập nhật vị trí</h3>
                <button class="close" onclick="hideLocationModal()">&times;</button>
            </div>
            <form id="locationForm">
                <div class="form-group">
                    <label for="rackSelect">ラック / Giá đỡ:</label>
                    <select id="rackSelect" required>
                        <option value="">選択してください / Vui lòng chọn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="rackLayerSelect">レイヤー / Tầng:</label>
                    <select id="rackLayerSelect" required>
                        <option value="">選択してください / Vui lòng chọn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employeeSelect">担当者 / Người thực hiện:</label>
                    <select id="employeeSelect" required>
                        <option value="">選択してください / Vui lòng chọn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="locationNotes">備考 / Ghi chú:</label>
                    <textarea id="locationNotes" rows="3" placeholder="備考を入力してください..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">更新 / Cập nhật</button>
                    <button type="button" onclick="hideLocationModal()">キャンセル / Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shipment Registration Modal -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">出荷登録 / Đăng ký vận chuyển</h3>
                <button class="close" onclick="hideShipmentModal()">&times;</button>
            </div>
            <form id="shipmentForm">
                <div class="form-group">
                    <label for="toCompanySelect">出荷先 / Đích đến:</label>
                    <select id="toCompanySelect" required>
                        <option value="">選択してください / Vui lòng chọn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="shipmentDate">出荷日 / Ngày vận chuyển:</label>
                    <input type="date" id="shipmentDate" required>
                </div>
                <div class="form-group">
                    <label for="handler">担当者 / Người xử lý:</label>
                    <input type="text" id="handler" placeholder="担当者名を入力してください...">
                </div>
                <div class="form-group">
                    <label for="shipmentNotes">備考 / Ghi chú:</label>
                    <textarea id="shipmentNotes" rows="3" placeholder="備考を入力してください..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">登録 / Đăng ký</button>
                    <button type="button" onclick="hideShipmentModal()">キャンセル / Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Comment Add Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">コメント追加 / Thêm bình luận</h3>
                <button class="close" onclick="hideCommentModal()">&times;</button>
            </div>
            <form id="commentForm">
                <div class="form-group">
                    <label for="commentEmployeeSelect">担当者 / Người bình luận:</label>
                    <select id="commentEmployeeSelect" required>
                        <option value="">選択してください / Vui lòng chọn</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="commentText">コメント / Bình luận:</label>
                    <textarea id="commentText" rows="4" required placeholder="コメントを入力してください..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">追加 / Thêm</button>
                    <button type="button" onclick="hideCommentModal()">キャンセル / Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingIndicator" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>データを読み込み中... / Đang tải dữ liệu...</p>
    </div>

    <!-- Error Display -->
    <div id="errorContainer" style="display: none; position: fixed; top: 120px; left: 15px; right: 15px; background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; z-index: 9998; border-left: 4px solid #dc3545; font-size: 14px; text-align: center;"></div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script src="detail-mold.js"></script>
    
    <script>
        // ===== V6.5 ENHANCED UI FUNCTIONS WITH OFFICIAL REPORT =====
        
        function showLocationModal() {
            document.getElementById('locationModal').style.display = 'block';
        }
        
        function hideLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
        }
        
        function showShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'block';
        }
        
        function hideShipmentModal() {
            document.getElementById('shipmentModal').style.display = 'none';
        }
        
        function showCommentModal() {
            document.getElementById('commentModal').style.display = 'block';
        }
        
        function hideCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
        }
        
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
        
        // V6.5: NEW - Official report function using form template
        function generateOfficialReport() {
            console.log('V6.5: Generating official report using form template...');
            
            if (typeof generateOfficialReportLayout === 'function') {
                generateOfficialReportLayout();
                
                // Wait for layout generation, then print
                setTimeout(() => {
                    window.print();
                }, 500);
            } else {
                console.error('V6.5: generateOfficialReportLayout function not found');
                window.print(); // Fallback
            }
        }
        
        // V6.5: NEW - Official PDF generation
        function generateOfficialPDF() {
            console.log('V6.5: Generating official PDF using form template...');
            
            if (typeof generateOfficialReportLayout === 'function') {
                generateOfficialReportLayout();
                
                // Wait for layout generation, then print to PDF
                setTimeout(() => {
                    // For Chrome/Edge - this will show print dialog with PDF option
                    window.print();
                }, 500);
            } else {
                console.error('V6.5: generateOfficialReportLayout function not found');
                window.print(); // Fallback
            }
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = ['locationModal', 'shipmentModal', 'commentModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
        }
        
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 130px;
                left: 15px;
                right: 15px;
                background: #d4edda;
                color: #155724;
                padding: 12px;
                border-radius: 6px;
                z-index: 9999;
                border-left: 4px solid #28a745;
                font-size: 14px;
                text-align: center;
                box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = show ? 'flex' : 'none';
            }
        }
        
        // V6.5: Enhanced scroll management for fixed tabs
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            const tabNav = document.querySelector('.tab-navigation');
            
            if (tabNav) {
                if (currentScroll > lastScrollTop && currentScroll > 200) {
                    // Scrolling down - hide tabs for more space
                    tabNav.style.transform = 'translateY(-100%)';
                } else {
                    // Scrolling up - show tabs
                    tabNav.style.transform = 'translateY(0)';
                }
            }
            
            lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        }, false);
        
        console.log('MoldCutterSearch V6.5 - Final HTML Structure Ready');
        console.log('✅ Conditional Header + Modern UI + Official Report Template');
    </script>
</body>
</html>
