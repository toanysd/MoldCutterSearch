<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi tiáº¿t khuÃ´n - Mold Detail V5.7</title>
    <!-- V5.7 - Tab-based Design + PDF Export + Based on V4.31 GitHub -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="detail-mold-styles.css">

    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="mold-detail-page">
    <!-- ===== COMPACT HEADER V5.7 - 2 LINES ===== -->
    <header class="detail-header-compact mold">
        <div class="container">
            <!-- Line 1: Title + Actions -->
            <div class="header-row-compact">
                <div class="header-left">
                    <button class="back-btn-compact" onclick="goBack()">â† æˆ»ã‚‹</button>
                    <div class="header-info-compact">
                        <div class="item-title-compact" id="moldTitle">Loading...</div>
                        <div class="item-subtitle-compact" id="moldSubtitle">é‡‘å‹è©³ç´°æƒ…å ±</div>
                    </div>
                </div>

                <div class="header-actions-compact">
                    <button id="showLocationBtn" class="action-btn-compact">
                        ğŸ“ ä½ç½®æ›´æ–°
                    </button>
                    <button id="showShipmentBtn" class="action-btn-compact">
                        ğŸšš å‡ºè·ç™»éŒ²
                    </button>
                    <button id="showCommentBtn" class="action-btn-compact">
                        ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ
                    </button>
                    <button onclick="window.print()" class="action-btn-compact">
                        ğŸ–¨ï¸ å°åˆ·
                    </button>
                    <button onclick="exportToPDF()" class="action-btn-compact">
                        ğŸ“„ PDFå‡ºåŠ›
                    </button>
                </div>
            </div>
        </div>

        <!-- Line 2: Tab Navigation -->
        <nav class="tab-navigation">
            <ul class="tab-nav">
                <li><a href="#summary" class="tab-link active" data-tab="summary">ğŸ“‹ æƒ…å ±ç·åˆ</a></li>
                <li><a href="#product" class="tab-link" data-tab="product">ğŸ“¦ è£½å“</a></li>
                <li><a href="#technical" class="tab-link" data-tab="technical">âš™ï¸ æŠ€è¡“</a></li>
                <li><a href="#processing" class="tab-link" data-tab="processing">ğŸ”„ å‡¦ç†ãƒ»å±¥æ­´</a></li>
            </ul>
        </nav>
    </header>

    <!-- ===== MAIN CONTENT WITH TABS V5.7 ===== -->
    <main class="tab-content-wrapper">

        <!-- PDF Header (Hidden, only for PDF export) -->
        <div id="pdfHeader" style="display: none;">
            <div class="pdf-header">
                <div class="pdf-title">é‡‘å‹è©³ç´°æƒ…å ± / Mold Detail Information</div>
                <div class="pdf-subtitle">MoldCutterSearch System V5.7</div>
            </div>
        </div>

        <!-- ===== TAB 1: æƒ…å ±ç·åˆ (SUMMARY) ===== -->
        <div id="summary" class="tab-pane active">
            <!-- Basic Information -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ·ï¸</div>
                    <h3 class="section-title">åŸºæœ¬æƒ…å ± / ThÃ´ng tin cÆ¡ báº£n</h3>
                </div>
                <div id="summaryBasicInfo" class="info-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Tray Information -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ“‹</div>
                    <h3 class="section-title">ãƒˆãƒ¬ã‚¤æƒ…å ± / ThÃ´ng tin khay</h3>
                </div>
                <div id="summaryTrayInfo" class="info-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Related Cutters -->
            <div class="content-section cutters-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ”§</div>
                    <h3 class="section-title">é–¢é€£ã‚«ãƒƒã‚¿ãƒ¼ / Dao cáº¯t liÃªn quan</h3>
                </div>
                <div id="summaryRelatedCutters">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ===== TAB 2: è£½å“ (PRODUCT) ===== -->
        <div id="product" class="tab-pane">
            <!-- Product Details -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ“¦</div>
                    <h3 class="section-title">è£½å“è©³ç´° / Chi tiáº¿t sáº£n pháº©m</h3>
                </div>
                <div id="productDetails" class="info-grid two-cols">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Business Information -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ’°</div>
                    <h3 class="section-title">å•†æ¥­æƒ…å ± / ThÃ´ng tin thÆ°Æ¡ng máº¡i</h3>
                </div>
                <div id="productBusinessInfo" class="info-grid two-cols">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ===== TAB 3: æŠ€è¡“ (TECHNICAL) ===== -->
        <div id="technical" class="tab-pane">
            <!-- Design Specifications -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">âš™ï¸</div>
                    <h3 class="section-title">è¨­è¨ˆä»•æ§˜ / ThÃ´ng sá»‘ thiáº¿t káº¿</h3>
                </div>
                <div id="technicalDesignSpecs" class="info-grid two-cols">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Manufacturing Details -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ”¨</div>
                    <h3 class="section-title">è£½é€ è©³ç´° / Chi tiáº¿t sáº£n xuáº¥t</h3>
                </div>
                <div id="technicalManufacturingDetails" class="info-grid two-cols">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- ===== TAB 4: å‡¦ç†ãƒ»å±¥æ­´ (PROCESSING & HISTORY) ===== -->
        <div id="processing" class="tab-pane">
            <!-- Processing Status -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ”„</div>
                    <h3 class="section-title">å‡¦ç†çŠ¶æ³ / TÃ¬nh tráº¡ng xá»­ lÃ½</h3>
                </div>
                <div id="processingStatus">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Location & Shipment History -->
            <div class="info-grid two-cols">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-icon">ğŸ“</div>
                        <h3 class="section-title">ä½ç½®å±¥æ­´ / Lá»‹ch sá»­ vá»‹ trÃ­</h3>
                    </div>
                    <div id="processingLocationHistory" class="history-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <div class="section-icon">ğŸšš</div>
                        <h3 class="section-title">å‡ºè·å±¥æ­´ / Lá»‹ch sá»­ váº­n chuyá»ƒn</h3>
                    </div>
                    <div id="processingShipmentHistory" class="history-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- User Comments -->
            <div class="content-section">
                <div class="section-header">
                    <div class="section-icon">ğŸ’¬</div>
                    <h3 class="section-title">ã‚³ãƒ¡ãƒ³ãƒˆ / BÃ¬nh luáº­n</h3>
                </div>
                <div id="processingUserComments">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- ===== MODALS V5.7 ===== -->
    <!-- Location Modal -->
    <div id="locationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ä½ç½®æ›´æ–° / Cáº­p nháº­t vá»‹ trÃ­</h3>
                <button class="close" onclick="hideLocationModal()">&times;</button>
            </div>
            <form id="locationForm">
                <div class="form-group">
                    <label>ãƒ©ãƒƒã‚¯ / GiÃ¡:</label>
                    <select id="rackSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„ / Chá»n giÃ¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ¬ã‚¤ãƒ¤ãƒ¼ / Táº§ng:</label>
                    <select id="rackLayerSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„ / Chá»n táº§ng</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“è€… / NgÆ°á»i thá»±c hiá»‡n:</label>
                    <select id="employeeSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„ / Chá»n ngÆ°á»i</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è€ƒ / Ghi chÃº:</label>
                    <textarea id="locationNotes" rows="3" placeholder="å‚™è€ƒã‚’å…¥åŠ›..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">æ›´æ–° / Cáº­p nháº­t</button>
                    <button type="button" onclick="hideLocationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ« / Há»§y</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shipment Modal -->
    <div id="shipmentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‡ºè·ç™»éŒ² / ÄÄƒng kÃ½ váº­n chuyá»ƒn</h3>
                <button class="close" onclick="hideShipmentModal()">&times;</button>
            </div>
            <form id="shipmentForm">
                <div class="form-group">
                    <label>å‡ºè·å…ˆ / ÄÃ­ch Ä‘áº¿n:</label>
                    <select id="toCompanySelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„ / Chá»n cÃ´ng ty</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‡ºè·æ—¥ / NgÃ y váº­n chuyá»ƒn:</label>
                    <input type="date" id="shipmentDate" required>
                </div>
                <div class="form-group">
                    <label>æ‹…å½“è€… / NgÆ°á»i thá»±c hiá»‡n:</label>
                    <input type="text" id="handler" placeholder="æ‹…å½“è€…åã‚’å…¥åŠ›...">
                </div>
                <div class="form-group">
                    <label>å‚™è€ƒ / Ghi chÃº:</label>
                    <textarea id="shipmentNotes" rows="3" placeholder="å‚™è€ƒã‚’å…¥åŠ›..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">ç™»éŒ² / ÄÄƒng kÃ½</button>
                    <button type="button" onclick="hideShipmentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ« / Há»§y</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ  / ThÃªm bÃ¬nh luáº­n</h3>
                <button class="close" onclick="hideCommentModal()">&times;</button>
            </div>
            <form id="commentForm">
                <div class="form-group">
                    <label>æ‹…å½“è€… / NgÆ°á»i bÃ¬nh luáº­n:</label>
                    <select id="commentEmployeeSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„ / Chá»n ngÆ°á»i</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ã‚³ãƒ¡ãƒ³ãƒˆ / BÃ¬nh luáº­n:</label>
                    <textarea id="commentText" rows="4" required placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">è¿½åŠ  / ThÃªm</button>
                    <button type="button" onclick="hideCommentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ« / Há»§y</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­... / Äang táº£i dá»¯ liá»‡u...</p>
    </div>

    <!-- Error Container -->
    <div id="errorContainer" style="display: none; position: fixed; top: 80px; left: 20px; right: 20px; background: #fee2e2; color: #991b1b; padding: 12px; border-radius: 8px; z-index: 9998; border-left: 4px solid #dc2626;"></div>

    <!-- JavaScript -->
    <script src="script.js"></script>
    <script src="detail-mold.js"></script>

    <script>
        // ===== TAB NAVIGATION V5.7 =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tab functionality
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Remove active class from all tabs and panes
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Show corresponding pane
                    const targetTab = this.getAttribute('data-tab');
                    const targetPane = document.getElementById(targetTab);
                    if (targetPane) {
                        targetPane.classList.add('active');
                    }
                });
            });

            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const modals = ['locationModal', 'shipmentModal', 'commentModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        hideModal(modalId);
                    }
                });
            });
        });

        // ===== PDF EXPORT V5.7 - æ–°è¦é‡‘å‹è£½ä½œæŒ‡ç¤ºæ›¸ FORMAT =====
        async function exportToPDF() {
            if (!currentMold) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                showLoading(true);

                // Show PDF header
                document.getElementById('pdfHeader').style.display = 'block';

                // Show all tab content for PDF
                const tabPanes = document.querySelectorAll('.tab-pane');
                tabPanes.forEach(pane => {
                    pane.style.display = 'block';
                });

                // Configure html2canvas for better quality
                const options = {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 1200,
                    height: window.innerHeight * 3
                };

                // Capture the content
                const canvas = await html2canvas(document.body, options);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = 210; // A4 width in mm
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                // Add image to PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                // Add company header
                pdf.setFontSize(16);
                pdf.text('æ ªå¼ä¼šç¤¾ãƒ¨ã‚·ãƒ€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸', 10, 10);
                pdf.setFontSize(12);
                pdf.text('é‡‘å‹è©³ç´°æƒ…å ± - ' + (currentMold.MoldCode || 'N/A'), 10, 20);

                // Save PDF
                const fileName = `Mold_Detail_${currentMold.MoldCode || currentMold.MoldID}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Hide PDF header and restore tab state
                document.getElementById('pdfHeader').style.display = 'none';
                tabPanes.forEach(pane => {
                    pane.style.display = 'none';
                });
                document.querySelector('.tab-pane.active').style.display = 'block';

                showSuccessNotification('PDFå‡ºåŠ›ãŒå®Œäº†ã—ã¾ã—ãŸ');

            } catch (error) {
                console.error('PDF export failed:', error);
                showErrorNotification('PDFå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // ===== MODAL CONTROLS V5.7 =====
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>